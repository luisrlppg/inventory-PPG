{% extends "base.html" %}

{% block title %}Inventario - Inventario PPG{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-clipboard-list me-2"></i>Inventario</h2>
    <div class="btn-group" role="group">
        <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#entradaMaterialModal">
            <i class="fas fa-plus me-1"></i>
            Entrada de Material
        </button>
        <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#salidaMaterialModal">
            <i class="fas fa-minus me-1"></i>
            Salida de Material
        </button>
    </div>
</div>

<!-- Barra de búsqueda principal -->
<div class="card mb-4">
    <div class="card-body">
        <form method="GET" id="filtrosForm" class="row g-3">
            <div class="col-md-6">
                <label for="search" class="form-label">Buscar Producto</label>
                <input type="text" class="form-control form-control-lg" id="search" name="search" 
                       value="{{ filters.search }}" placeholder="Buscar por descripción, código o categoría...">
            </div>
            <div class="col-md-4">
                <label for="categoria" class="form-label">Filtrar por Categoría</label>
                <select class="form-select form-select-lg" id="categoria" name="categoria">
                    <option value="">Todas las categorías</option>
                    {% for categoria in categorias %}
                    <option value="{{ categoria.nombre }}" 
                            {{ 'selected' if filters.categoria == categoria.nombre }}>
                        {{ categoria.nombre }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <div class="btn-group w-100" role="group">
                    <button type="submit" class="btn btn-primary btn-lg" title="Buscar">
                        <i class="fas fa-search"></i>
                    </button>
                    <button type="button" class="btn btn-outline-secondary btn-lg" onclick="limpiarFiltros()" title="Limpiar">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Lista de productos -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
            <i class="fas fa-list me-2"></i>
            Lista de Productos en Inventario
        </h5>
        <span class="badge bg-primary">{{ productos|length }} productos</span>
    </div>
    <div class="card-body p-0">
        {% if productos %}
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Producto</th>
                        <th>Código</th>
                        <th>Categoría</th>
                        <th>Stock Total</th>
                        <th>Requerido</th>
                        <th>Estado</th>
                        <th>Ubicaciones</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for producto in productos %}
                    <tr {% if session.admin_username %}class="admin-row" onclick="editarStockRapido({{ producto.id }}, '{{ producto.descripcion }}')" style="cursor: pointer;"{% endif %}>
                        <td>
                            <div>
                                <strong>{{ producto.descripcion }}</strong>
                                {% if producto.notas %}
                                <br><small class="text-muted">{{ producto.notas[:60] }}{% if producto.notas|length > 60 %}...{% endif %}</small>
                                {% endif %}
                            </div>
                        </td>
                        <td>
                            {% if producto.codigo %}
                                <span class="badge bg-secondary">{{ producto.codigo }}</span>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            <div>
                                {{ producto.categoria or '-' }}
                                {% if producto.subcategoria %}
                                <br><small class="text-muted">{{ producto.subcategoria }}</small>
                                {% endif %}
                            </div>
                        </td>
                        <td>
                            <span class="fs-4 fw-bold 
                                {% if producto.stock_total >= producto.cantidad_requerida %}text-success
                                {% elif producto.stock_total > 0 %}text-warning
                                {% else %}text-danger{% endif %}">
                                {{ producto.stock_total }}
                            </span>
                        </td>
                        <td>{{ producto.cantidad_requerida }}</td>
                        <td>
                            {% if producto.stock_total >= producto.cantidad_requerida %}
                                <span class="badge bg-success">Stock OK</span>
                            {% elif producto.stock_total > 0 %}
                                <span class="badge bg-warning">Stock Bajo</span>
                            {% else %}
                                <span class="badge bg-danger">Sin Stock</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if producto.ubicaciones_detalle %}
                                <small class="text-muted">
                                    {% set ubicaciones = producto.ubicaciones_detalle.split(', ') %}
                                    {% for ubicacion in ubicaciones[:3] %}
                                        {% if ubicacion and ':' in ubicacion %}
                                            {% set parts = ubicacion.split(':') %}
                                            <span class="badge bg-info me-1">{{ parts[0] }}: {{ parts[1] }}</span>
                                        {% endif %}
                                    {% endfor %}
                                    {% if ubicaciones|length > 3 %}
                                        <span class="text-muted">+{{ ubicaciones|length - 3 }} más</span>
                                    {% endif %}
                                </small>
                            {% else %}
                                <span class="text-muted">Sin ubicación</span>
                            {% endif %}
                        </td>
                        <td>
                            <button type="button" class="btn btn-sm btn-success" 
                                    onclick="agregarStockProducto({{ producto.id }}, '{{ producto.descripcion }}')"
                                    title="Agregar a ubicación">
                                <i class="fas fa-plus"></i>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-5">
            <i class="fas fa-search fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">No se encontraron productos</h5>
            <p class="text-muted">
                {% if filters.search or filters.categoria %}
                    Intenta ajustar la búsqueda o 
                    <button type="button" class="btn btn-link p-0" onclick="limpiarFiltros()">limpiar los filtros</button>
                {% else %}
                    No hay productos en el sistema. 
                    <a href="{{ url_for('nuevo_producto') }}" class="btn btn-primary">
                        <i class="fas fa-plus me-1"></i>
                        Agregar primer producto
                    </a>
                {% endif %}
            </p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Modal para edición rápida de stock (solo administradores) -->
{% if session.admin_username %}
<div class="modal fade" id="editarStockModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title">
                    <i class="fas fa-edit me-2"></i>
                    Edición Rápida de Stock - ADMINISTRADOR
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Modo Administrador:</strong> Esta operación será registrada en los logs del sistema.
                </div>
                
                <div id="producto-info" class="mb-4">
                    <!-- Información del producto se carga dinámicamente -->
                </div>
                
                <div id="ubicaciones-stock">
                    <!-- Lista de ubicaciones se carga dinámicamente -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-warning" id="guardarCambiosStock">
                    <i class="fas fa-save me-1"></i>
                    Guardar Cambios
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Modal para entrada de material -->
<div class="modal fade" id="entradaMaterialModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus me-2"></i>
                    Entrada de Material
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('agregar_stock') }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="buscar_producto_entrada" class="form-label">Buscar Producto</label>
                        <input type="text" class="form-control" id="buscar_producto_entrada" 
                               placeholder="Escribir nombre del producto..." 
                               onkeyup="filtrarProductosEntrada()">
                        <input type="hidden" name="producto_id" id="producto_id_entrada" required>
                        
                        <div id="lista_productos_entrada" class="mt-2" style="max-height: 200px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0.375rem; display: none;">
                            {% for producto in productos %}
                            <div class="producto-item p-2 border-bottom" 
                                 data-id="{{ producto.id }}" 
                                 data-nombre="{{ producto.descripcion }}"
                                 data-codigo="{{ producto.codigo or '' }}"
                                 onclick="seleccionarProductoEntrada({{ producto.id }}, '{{ producto.descripcion }}', '{{ producto.codigo or '' }}')">
                                <strong>{{ producto.descripcion }}</strong>
                                {% if producto.codigo %}
                                <br><small class="text-muted">Código: {{ producto.codigo }}</small>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                        
                        <div id="producto_seleccionado_entrada" class="mt-2 alert alert-info" style="display: none;">
                            <i class="fas fa-check me-2"></i>
                            <span id="nombre_producto_entrada"></span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="ubicacion_codigo" class="form-label">Ubicación</label>
                        <input type="text" class="form-control" name="ubicacion_codigo" 
                               placeholder="Ej: A1, B2, C3..." required list="ubicaciones_list">
                        <datalist id="ubicaciones_list">
                            {% for ubicacion in ubicaciones %}
                            <option value="{{ ubicacion.codigo }}">
                            {% endfor %}
                        </datalist>
                        <div class="form-text">Si la ubicación no existe, se creará automáticamente</div>
                    </div>
                    <div class="mb-3">
                        <label for="cantidad" class="form-label">Cantidad a Ingresar</label>
                        <input type="number" class="form-control" name="cantidad" min="1" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-plus me-1"></i>
                        Registrar Entrada
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- Modal para salida de material -->
<div class="modal fade" id="salidaMaterialModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-minus me-2"></i>
                    Salida de Material
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('salida_stock') }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="buscar_producto_salida" class="form-label">Buscar Producto</label>
                        <input type="text" class="form-control" id="buscar_producto_salida" 
                               placeholder="Escribir nombre del producto..." 
                               onkeyup="filtrarProductosSalida()">
                        <input type="hidden" name="producto_id" id="producto_id_salida" required>
                        
                        <div id="lista_productos_salida" class="mt-2" style="max-height: 200px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0.375rem; display: none;">
                            {% for producto in productos %}
                                {% if producto.stock_total > 0 %}
                                <div class="producto-item p-2 border-bottom" 
                                     data-id="{{ producto.id }}" 
                                     data-nombre="{{ producto.descripcion }}"
                                     data-codigo="{{ producto.codigo or '' }}"
                                     data-stock="{{ producto.stock_total }}"
                                     onclick="seleccionarProductoSalida({{ producto.id }}, '{{ producto.descripcion }}', '{{ producto.codigo or '' }}', {{ producto.stock_total }})">
                                    <strong>{{ producto.descripcion }}</strong>
                                    <span class="badge bg-success ms-2">Stock: {{ producto.stock_total }}</span>
                                    {% if producto.codigo %}
                                    <br><small class="text-muted">Código: {{ producto.codigo }}</small>
                                    {% endif %}
                                </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                        
                        <div id="producto_seleccionado_salida" class="mt-2 alert alert-info" style="display: none;">
                            <i class="fas fa-check me-2"></i>
                            <span id="nombre_producto_salida"></span>
                            <span id="stock_producto_salida" class="badge bg-success ms-2"></span>
                        </div>
                        <div class="form-text">Solo se muestran productos con stock disponible</div>
                    </div>
                    <div class="mb-3">
                        <label for="salida_ubicacion_id" class="form-label">Ubicación</label>
                        <select class="form-select" name="ubicacion_id" id="salida_ubicacion_id" onchange="mostrarStockDisponible()" required>
                            <option value="">Primero selecciona un producto</option>
                        </select>
                        <div id="stock_disponible_info" class="form-text"></div>
                    </div>
                    <div class="mb-3">
                        <label for="salida_cantidad" class="form-label">Cantidad a Retirar</label>
                        <input type="number" class="form-control" name="cantidad" id="salida_cantidad" min="1" required>
                        <div class="form-text">Máximo disponible: <span id="max_cantidad">0</span></div>
                    </div>
                    <div class="mb-3">
                        <label for="motivo_salida" class="form-label">Motivo de la Salida</label>
                        <select class="form-select" name="motivo" id="motivo_salida">
                            <option value="uso_produccion">Uso en producción</option>
                            <option value="mantenimiento">Mantenimiento</option>
                            <option value="reparacion">Reparación</option>
                            <option value="transferencia">Transferencia</option>
                            <option value="otros">Otros</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger" id="btn_confirmar_salida" disabled>
                        <i class="fas fa-minus me-1"></i>
                        Registrar Salida
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function agregarStockProducto(productoId, productoNombre) {
    // Pre-seleccionar el producto en el modal de entrada
    document.getElementById('producto_id_entrada').value = productoId;
    document.getElementById('buscar_producto_entrada').value = productoNombre;
    document.getElementById('nombre_producto_entrada').textContent = productoNombre;
    document.getElementById('producto_seleccionado_entrada').style.display = 'block';
    document.getElementById('lista_productos_entrada').style.display = 'none';
    
    // Mostrar el modal
    new bootstrap.Modal(document.getElementById('entradaMaterialModal')).show();
}

// Función para filtrar productos en entrada de material
function filtrarProductosEntrada() {
    const busqueda = document.getElementById('buscar_producto_entrada').value.toLowerCase();
    const listaProductos = document.getElementById('lista_productos_entrada');
    const productosItems = listaProductos.querySelectorAll('.producto-item');
    
    if (busqueda.length === 0) {
        listaProductos.style.display = 'none';
        return;
    }
    
    let hayCoincidencias = false;
    productosItems.forEach(item => {
        const nombre = item.getAttribute('data-nombre').toLowerCase();
        const codigo = item.getAttribute('data-codigo').toLowerCase();
        
        if (nombre.includes(busqueda) || codigo.includes(busqueda)) {
            item.style.display = 'block';
            hayCoincidencias = true;
        } else {
            item.style.display = 'none';
        }
    });
    
    listaProductos.style.display = hayCoincidencias ? 'block' : 'none';
}

// Función para seleccionar producto en entrada de material
function seleccionarProductoEntrada(id, nombre, codigo) {
    document.getElementById('producto_id_entrada').value = id;
    document.getElementById('buscar_producto_entrada').value = nombre;
    document.getElementById('nombre_producto_entrada').textContent = nombre + (codigo ? ` (${codigo})` : '');
    document.getElementById('producto_seleccionado_entrada').style.display = 'block';
    document.getElementById('lista_productos_entrada').style.display = 'none';
}

// Función para filtrar productos en salida de material (solo con stock)
function filtrarProductosSalida() {
    const busqueda = document.getElementById('buscar_producto_salida').value.toLowerCase();
    const listaProductos = document.getElementById('lista_productos_salida');
    const productosItems = listaProductos.querySelectorAll('.producto-item');
    
    if (busqueda.length === 0) {
        listaProductos.style.display = 'none';
        return;
    }
    
    let hayCoincidencias = false;
    productosItems.forEach(item => {
        const nombre = item.getAttribute('data-nombre').toLowerCase();
        const codigo = item.getAttribute('data-codigo').toLowerCase();
        const stock = parseInt(item.getAttribute('data-stock'));
        
        // Solo mostrar productos con stock > 0
        if (stock > 0 && (nombre.includes(busqueda) || codigo.includes(busqueda))) {
            item.style.display = 'block';
            hayCoincidencias = true;
        } else {
            item.style.display = 'none';
        }
    });
    
    listaProductos.style.display = hayCoincidencias ? 'block' : 'none';
}

// Función para seleccionar producto en salida de material
function seleccionarProductoSalida(id, nombre, codigo, stock) {
    document.getElementById('producto_id_salida').value = id;
    document.getElementById('buscar_producto_salida').value = nombre;
    document.getElementById('nombre_producto_salida').textContent = nombre + (codigo ? ` (${codigo})` : '');
    document.getElementById('stock_producto_salida').textContent = `Stock: ${stock}`;
    document.getElementById('producto_seleccionado_salida').style.display = 'block';
    document.getElementById('lista_productos_salida').style.display = 'none';
    
    // Cargar ubicaciones con stock para este producto
    cargarUbicacionesConStock();
}

// Variables globales para el control de stock
let ubicacionesConStock = {};

function cargarUbicacionesConStock() {
    const productoId = document.getElementById('producto_id_salida').value;
    const ubicacionSelect = document.getElementById('salida_ubicacion_id');
    const btnConfirmar = document.getElementById('btn_confirmar_salida');
    
    // Limpiar ubicaciones
    ubicacionSelect.innerHTML = '<option value="">Cargando ubicaciones...</option>';
    btnConfirmar.disabled = true;
    
    if (productoId) {
        fetch(`/api/producto/${productoId}/ubicaciones-stock`)
            .then(response => response.json())
            .then(data => {
                ubicacionSelect.innerHTML = '<option value="">Seleccionar ubicación...</option>';
                ubicacionesConStock = {};
                
                if (data.ubicaciones && data.ubicaciones.length > 0) {
                    data.ubicaciones.forEach(ubicacion => {
                        const option = document.createElement('option');
                        option.value = ubicacion.ubicacion_id;
                        option.textContent = `${ubicacion.codigo} - Stock: ${ubicacion.cantidad}`;
                        ubicacionSelect.appendChild(option);
                        
                        // Guardar info de stock para validación
                        ubicacionesConStock[ubicacion.ubicacion_id] = ubicacion.cantidad;
                    });
                } else {
                    ubicacionSelect.innerHTML = '<option value="">No hay stock disponible</option>';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                ubicacionSelect.innerHTML = '<option value="">Error al cargar ubicaciones</option>';
            });
    } else {
        ubicacionSelect.innerHTML = '<option value="">Primero selecciona un producto</option>';
    }
}

function mostrarStockDisponible() {
    const ubicacionId = document.getElementById('salida_ubicacion_id').value;
    const cantidadInput = document.getElementById('salida_cantidad');
    const maxCantidadSpan = document.getElementById('max_cantidad');
    const stockInfo = document.getElementById('stock_disponible_info');
    const btnConfirmar = document.getElementById('btn_confirmar_salida');
    
    if (ubicacionId && ubicacionesConStock[ubicacionId]) {
        const stockDisponible = ubicacionesConStock[ubicacionId];
        maxCantidadSpan.textContent = stockDisponible;
        cantidadInput.max = stockDisponible;
        cantidadInput.value = '';
        stockInfo.textContent = `Stock disponible en esta ubicación: ${stockDisponible}`;
        stockInfo.className = 'form-text text-info';
        btnConfirmar.disabled = false;
        
        // Validar cantidad en tiempo real
        cantidadInput.oninput = function() {
            const cantidad = parseInt(this.value);
            if (cantidad > stockDisponible) {
                this.value = stockDisponible;
                stockInfo.textContent = `Cantidad ajustada al máximo disponible: ${stockDisponible}`;
                stockInfo.className = 'form-text text-warning';
            } else if (cantidad > 0) {
                stockInfo.textContent = `Stock disponible en esta ubicación: ${stockDisponible}`;
                stockInfo.className = 'form-text text-info';
            }
        };
    } else {
        maxCantidadSpan.textContent = '0';
        cantidadInput.max = 0;
        cantidadInput.value = '';
        stockInfo.textContent = '';
        btnConfirmar.disabled = true;
    }
}

// Enfocar en la barra de búsqueda al cargar la página
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('search').focus();
    
    // Event listeners para limpiar selección cuando se empieza a escribir de nuevo
    document.getElementById('buscar_producto_entrada').addEventListener('input', function() {
        if (this.value === '') {
            document.getElementById('producto_seleccionado_entrada').style.display = 'none';
            document.getElementById('producto_id_entrada').value = '';
        }
    });
    
    document.getElementById('buscar_producto_salida').addEventListener('input', function() {
        if (this.value === '') {
            document.getElementById('producto_seleccionado_salida').style.display = 'none';
            document.getElementById('producto_id_salida').value = '';
            document.getElementById('salida_ubicacion_id').innerHTML = '<option value="">Primero selecciona un producto</option>';
            document.getElementById('btn_confirmar_salida').disabled = true;
        }
    });
});

function limpiarFiltros() {
    document.getElementById('search').value = '';
    document.getElementById('categoria').value = '';
    document.getElementById('filtrosForm').submit();
}

// Funciones de administrador para edición rápida
{% if session.admin_username %}
let cambiosStock = {};

function editarStockRapido(productoId, productoNombre) {
    // Cargar información del producto y sus ubicaciones
    fetch(`/api/producto/${productoId}/ubicaciones-stock`)
        .then(response => response.json())
        .then(data => {
            // Mostrar información del producto
            document.getElementById('producto-info').innerHTML = `
                <div class="card">
                    <div class="card-body">
                        <h6><i class="fas fa-box me-2"></i>${productoNombre}</h6>
                        <small class="text-muted">ID: ${productoId}</small>
                    </div>
                </div>
            `;
            
            // Mostrar ubicaciones con stock
            let ubicacionesHtml = '';
            if (data.ubicaciones && data.ubicaciones.length > 0) {
                ubicacionesHtml = `
                    <h6><i class="fas fa-map-marker-alt me-2"></i>Ubicaciones con Stock</h6>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Ubicación</th>
                                    <th>Stock Actual</th>
                                    <th>Nuevo Stock</th>
                                    <th>Acción</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                data.ubicaciones.forEach(ubicacion => {
                    ubicacionesHtml += `
                        <tr>
                            <td><span class="badge bg-info">${ubicacion.codigo}</span></td>
                            <td><strong>${ubicacion.cantidad}</strong></td>
                            <td>
                                <input type="number" class="form-control form-control-sm" 
                                       id="stock_${ubicacion.ubicacion_id}" 
                                       value="${ubicacion.cantidad}" 
                                       min="0"
                                       onchange="registrarCambio(${productoId}, ${ubicacion.ubicacion_id}, ${ubicacion.cantidad}, this.value)">
                            </td>
                            <td>
                                <button type="button" class="btn btn-sm btn-danger" 
                                        onclick="eliminarUbicacion(${productoId}, ${ubicacion.ubicacion_id}, '${ubicacion.codigo}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                ubicacionesHtml += `
                            </tbody>
                        </table>
                    </div>
                `;
            } else {
                ubicacionesHtml = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Este producto no tiene stock en ninguna ubicación
                    </div>
                `;
            }
            
            document.getElementById('ubicaciones-stock').innerHTML = ubicacionesHtml;
            
            // Limpiar cambios pendientes
            cambiosStock = {};
            
            // Mostrar modal
            new bootstrap.Modal(document.getElementById('editarStockModal')).show();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al cargar información del producto');
        });
}

function registrarCambio(productoId, ubicacionId, stockActual, nuevoStock) {
    const key = `${productoId}_${ubicacionId}`;
    if (parseInt(nuevoStock) !== parseInt(stockActual)) {
        cambiosStock[key] = {
            producto_id: productoId,
            ubicacion_id: ubicacionId,
            stock_actual: parseInt(stockActual),
            nuevo_stock: parseInt(nuevoStock)
        };
    } else {
        delete cambiosStock[key];
    }
    
    // Habilitar/deshabilitar botón de guardar
    const btnGuardar = document.getElementById('guardarCambiosStock');
    btnGuardar.disabled = Object.keys(cambiosStock).length === 0;
}

function eliminarUbicacion(productoId, ubicacionId, codigoUbicacion) {
    if (confirm(`¿Estás seguro de eliminar todo el stock de la ubicación ${codigoUbicacion}?`)) {
        const key = `${productoId}_${ubicacionId}`;
        cambiosStock[key] = {
            producto_id: productoId,
            ubicacion_id: ubicacionId,
            stock_actual: parseInt(document.getElementById(`stock_${ubicacionId}`).getAttribute('data-original') || 0),
            nuevo_stock: 0
        };
        
        document.getElementById(`stock_${ubicacionId}`).value = 0;
        document.getElementById('guardarCambiosStock').disabled = false;
    }
}

// Event listener para guardar cambios
document.addEventListener('DOMContentLoaded', function() {
    const btnGuardar = document.getElementById('guardarCambiosStock');
    if (btnGuardar) {
        btnGuardar.addEventListener('click', function() {
            if (Object.keys(cambiosStock).length === 0) {
                alert('No hay cambios para guardar');
                return;
            }
            
            if (!confirm(`¿Confirmar ${Object.keys(cambiosStock).length} cambio(s) de stock?`)) {
                return;
            }
            
            // Enviar cambios al servidor
            fetch('/admin/actualizar-stock-rapido', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({cambios: cambiosStock})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`✅ ${data.cambios_aplicados} cambio(s) aplicado(s) correctamente`);
                    location.reload(); // Recargar página para ver cambios
                } else {
                    alert(`❌ Error: ${data.error}`);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al guardar cambios');
            });
        });
    }
});
{% endif %}
</script>
{% endblock %}