{% extends "base.html" %}

{% block title %}{{ 'Editar' if producto else 'Nuevo' }} Producto - Inventario de Refacciones{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="fas fa-{{ 'edit' if producto else 'plus' }} me-2"></i>
        {{ 'Editar' if producto else 'Nuevo' }} Producto
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="{{ url_for('productos') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i>
            Volver a Productos
        </a>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    Información del Producto
                </h6>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('guardar_producto') }}">
                    {% if producto %}
                    <input type="hidden" name="producto_id" value="{{ producto.id }}">
                    {% endif %}
                    
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="descripcion" class="form-label">Descripción *</label>
                                <input type="text" class="form-control" id="descripcion" name="descripcion" 
                                       value="{{ producto.descripcion if producto else '' }}" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="codigo" class="form-label">Código</label>
                                <input type="text" class="form-control" id="codigo" name="codigo" 
                                       value="{{ producto.codigo if producto else '' }}">
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="categoria_id" class="form-label">Categoría</label>
                                <select class="form-select" id="categoria_id" name="categoria_id" onchange="cargarSubcategorias()">
                                    <option value="">Seleccionar categoría...</option>
                                    {% for categoria in categorias %}
                                    <option value="{{ categoria.id }}" 
                                            {{ 'selected' if producto and producto.categoria_id == categoria.id }}>
                                        {{ categoria.nombre }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="subcategoria_id" class="form-label">Subcategoría</label>
                                <select class="form-select" id="subcategoria_id" name="subcategoria_id">
                                    <option value="">Seleccionar subcategoría...</option>
                                    {% if subcategorias %}
                                        {% for subcategoria in subcategorias %}
                                        <option value="{{ subcategoria.id }}" 
                                                {{ 'selected' if producto and producto.subcategoria_id == subcategoria.id }}>
                                            {{ subcategoria.nombre }}
                                        </option>
                                        {% endfor %}
                                    {% endif %}
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="marca_id" class="form-label">Marca</label>
                                <select class="form-select" id="marca_id" name="marca_id">
                                    <option value="">Seleccionar marca...</option>
                                    {% for marca in marcas %}
                                    <option value="{{ marca.id }}" 
                                            {{ 'selected' if producto and producto.marca_id == marca.id }}>
                                        {{ marca.nombre }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="maquina_id" class="form-label">Máquina</label>
                                <select class="form-select" id="maquina_id" name="maquina_id">
                                    <option value="">Seleccionar máquina...</option>
                                    {% for maquina in maquinas %}
                                    <option value="{{ maquina.id }}" 
                                            {{ 'selected' if producto and producto.maquina_id == maquina.id }}>
                                        {{ maquina.nombre }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="cantidad_requerida" class="form-label">Cantidad Requerida por Máquina</label>
                        <input type="number" class="form-control" id="cantidad_requerida" name="cantidad_requerida" 
                               value="{{ producto.cantidad_requerida if producto else 1 }}" min="0">
                    </div>

                    <div class="mb-3">
                        <label for="notas" class="form-label">Notas Adicionales</label>
                        <textarea class="form-control" id="notas" name="notas" rows="3">{{ producto.notas if producto else '' }}</textarea>
                    </div>

                    <div class="mb-3">
                        <label for="imagen_ruta" class="form-label">Ruta de Imagen</label>
                        <input type="text" class="form-control" id="imagen_ruta" name="imagen_ruta" 
                               value="{{ producto.imagen_ruta if producto else '' }}"
                               placeholder="Se generará automáticamente basada en el ID">
                        <div class="form-text">
                            La imagen se buscará automáticamente como: imagenes/[ID].jpg
                        </div>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('productos') }}" class="btn btn-secondary me-md-2">
                            <i class="fas fa-times me-1"></i>
                            Cancelar
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-1"></i>
                            {{ 'Actualizar' if producto else 'Guardar' }} Producto
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <!-- Vista previa de la imagen -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-info">Vista Previa</h6>
            </div>
            <div class="card-body text-center">
                {% if producto %}
                <img id="preview-image" src="/imagenes/{{ producto.id }}.jpg" 
                     class="img-fluid rounded mb-3" 
                     style="max-height: 200px;"
                     onerror="handleImageError(this)"
                     alt="Producto {{ producto.id }}">
                <p class="text-muted">Imagen del producto</p>
                {% else %}
                <div class="text-muted">
                    <i class="fas fa-image fa-3x mb-3"></i>
                    <p>La imagen se mostrará después de guardar el producto</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Acciones rápidas -->
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-success">Acciones Rápidas</h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-outline-info" onclick="agregarCategoria()">
                        <i class="fas fa-plus me-1"></i>
                        Nueva Categoría
                    </button>
                    <button type="button" class="btn btn-outline-info" onclick="agregarMarca()">
                        <i class="fas fa-plus me-1"></i>
                        Nueva Marca
                    </button>
                    <button type="button" class="btn btn-outline-info" onclick="agregarMaquina()">
                        <i class="fas fa-plus me-1"></i>
                        Nueva Máquina
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modales para agregar elementos rápidamente -->
<div class="modal fade" id="nuevaCategoriaModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Nueva Categoría</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="nuevaCategoriaForm">
                    <div class="mb-3">
                        <label for="nueva_categoria_nombre" class="form-label">Nombre de la Categoría</label>
                        <input type="text" class="form-control" id="nueva_categoria_nombre" required>
                    </div>
                    <div class="mb-3">
                        <label for="nueva_categoria_descripcion" class="form-label">Descripción</label>
                        <textarea class="form-control" id="nueva_categoria_descripcion" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="guardarCategoria()">Guardar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function cargarSubcategorias() {
    const categoriaId = document.getElementById('categoria_id').value;
    const subcategoriaSelect = document.getElementById('subcategoria_id');
    
    // Limpiar subcategorías
    subcategoriaSelect.innerHTML = '<option value="">Seleccionar subcategoría...</option>';
    
    if (categoriaId) {
        fetch(`/api/subcategorias/${categoriaId}`)
            .then(response => response.json())
            .then(data => {
                data.forEach(subcategoria => {
                    const option = document.createElement('option');
                    option.value = subcategoria.id;
                    option.textContent = subcategoria.nombre;
                    subcategoriaSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error cargando subcategorías:', error);
            });
    }
}

function agregarCategoria() {
    new bootstrap.Modal(document.getElementById('nuevaCategoriaModal')).show();
}

function agregarMarca() {
    const nombre = prompt('Nombre de la nueva marca:');
    if (nombre) {
        // Implementar llamada AJAX para agregar marca
        alert('Funcionalidad en desarrollo');
    }
}

function agregarMaquina() {
    const nombre = prompt('Nombre de la nueva máquina:');
    if (nombre) {
        // Implementar llamada AJAX para agregar máquina
        alert('Funcionalidad en desarrollo');
    }
}

function guardarCategoria() {
    const nombre = document.getElementById('nueva_categoria_nombre').value;
    const descripcion = document.getElementById('nueva_categoria_descripcion').value;
    
    if (nombre) {
        // Implementar llamada AJAX para guardar categoría
        alert('Funcionalidad en desarrollo');
        bootstrap.Modal.getInstance(document.getElementById('nuevaCategoriaModal')).hide();
    }
}

// Cargar subcategorías al cargar la página si hay una categoría seleccionada
document.addEventListener('DOMContentLoaded', function() {
    const categoriaId = document.getElementById('categoria_id').value;
    if (categoriaId) {
        cargarSubcategorias();
    }
});
</script>
{% endblock %}