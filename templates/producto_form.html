{% extends "base.html" %}

{% block title %}{{ 'Editar' if producto else 'Nuevo' }} Producto - Inventario PPG{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-{{ 'edit' if producto else 'plus' }} me-2"></i>{{ 'Editar' if producto else 'Nuevo' }} Producto</h2>
    <a href="{{ url_for('productos') }}" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left me-1"></i>
        Volver a Productos
    </a>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">{{ 'Editar' if producto else 'Nueva' }} Información del Producto</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('guardar_producto') }}">
                    {% if producto %}
                    <input type="hidden" name="producto_id" value="{{ producto.id }}">
                    {% endif %}
                    
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="descripcion" class="form-label">Descripción *</label>
                                <input type="text" class="form-control" id="descripcion" name="descripcion" 
                                       value="{{ producto.descripcion if producto else '' }}" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="codigo" class="form-label">Código</label>
                                <input type="text" class="form-control" id="codigo" name="codigo"
                                       value="{{ producto.codigo if producto else '' }}">
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="categoria_id" class="form-label">Categoría</label>
                                <select class="form-select" id="categoria_id" name="categoria_id" onchange="cargarSubcategorias()">
                                    <option value="">Seleccionar categoría...</option>
                                    {% for categoria in categorias %}
                                    <option value="{{ categoria.id }}" 
                                            {{ 'selected' if producto and producto.categoria_id == categoria.id }}>
                                        {{ categoria.nombre }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="subcategoria_id" class="form-label">Subcategoría</label>
                                <select class="form-select" id="subcategoria_id" name="subcategoria_id">
                                    <option value="">Seleccionar subcategoría...</option>
                                    {% if subcategorias %}
                                        {% for subcategoria in subcategorias %}
                                        <option value="{{ subcategoria.id }}" 
                                                {{ 'selected' if producto and producto.subcategoria_id == subcategoria.id }}>
                                            {{ subcategoria.nombre }}
                                        </option>
                                        {% endfor %}
                                    {% endif %}
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="marca_id" class="form-label">Marca</label>
                                <select class="form-select" id="marca_id" name="marca_id">
                                    <option value="">Seleccionar marca...</option>
                                    {% for marca in marcas %}
                                    <option value="{{ marca.id }}" 
                                            {{ 'selected' if producto and producto.marca_id == marca.id }}>
                                        {{ marca.nombre }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="proveedor_id" class="form-label">Proveedor</label>
                                <select class="form-select" id="proveedor_id" name="proveedor_id">
                                    <option value="">Seleccionar proveedor...</option>
                                    {% for proveedor in proveedores %}
                                    <option value="{{ proveedor.id }}" 
                                            {{ 'selected' if producto and producto.proveedor_id == proveedor.id }}>
                                        {{ proveedor.nombre }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="maquina_id" class="form-label">Máquina</label>
                                <select class="form-select" id="maquina_id" name="maquina_id">
                                    <option value="">Seleccionar máquina...</option>
                                    {% for maquina in maquinas %}
                                    <option value="{{ maquina.id }}" 
                                            {{ 'selected' if producto and producto.maquina_id == maquina.id }}>
                                        {{ maquina.nombre }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="cantidad_requerida" class="form-label">Cantidad Requerida</label>
                                <input type="number" class="form-control" id="cantidad_requerida" name="cantidad_requerida" 
                                       value="{{ producto.cantidad_requerida if producto else 1 }}" min="0">
                                <div class="form-text">Cantidad mínima necesaria en inventario</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="stock_minimo" class="form-label">Stock Mínimo para Alertas</label>
                                <input type="number" class="form-control" id="stock_minimo" name="stock_minimo" 
                                       value="{{ producto.stock_minimo if producto else 5 }}" min="0">
                                <div class="form-text">Nivel mínimo para generar alertas automáticas</div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="notas" class="form-label">Notas Adicionales</label>
                        <textarea class="form-control" id="notas" name="notas" rows="3" 
                                  placeholder="Información adicional sobre el producto...">{{ producto.notas if producto else '' }}</textarea>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('productos') }}" class="btn btn-secondary me-md-2">
                            <i class="fas fa-times me-1"></i>
                            Cancelar
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-1"></i>
                            {{ 'Actualizar' if producto else 'Guardar' }} Producto
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">{{ 'Vista Previa' if producto else 'Información' }}</h5>
            </div>
            <div class="card-body text-center">
                {% if producto %}
                <img src="/imagenes/{{ producto.id }}.jpg" 
                     class="img-fluid rounded mb-3" 
                     style="max-height: 200px;"
                     onerror="handleImageError(this)"
                     alt="Producto {{ producto.id }}">
                <p class="text-muted">Imagen del producto ID: {{ producto.id }}</p>
                
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Editando producto:</strong><br>
                    ID: {{ producto.id }}<br>
                    Creado: {{ producto.fecha_creacion }}<br>
                    {% if producto.fecha_actualizacion != producto.fecha_creacion %}
                    Actualizado: {{ producto.fecha_actualizacion }}
                    {% endif %}
                </div>
                {% else %}
                <div class="text-muted">
                    <i class="fas fa-image fa-3x mb-3"></i>
                    <p>La imagen se mostrará después de guardar el producto</p>
                </div>
                
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Imagen del producto:</strong><br>
                    La imagen se mostrará automáticamente cuando el producto tenga un ID asignado. 
                    Guarda la imagen como <code>imagenes/[ID].jpg</code>
                </div>
                {% endif %}
                
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Campos obligatorios:</strong><br>
                    Solo la <strong>descripción</strong> es obligatoria. Los demás campos son opcionales.
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function cargarSubcategorias() {
    const categoriaId = document.getElementById('categoria_id').value;
    const subcategoriaSelect = document.getElementById('subcategoria_id');
    const subcategoriaActual = '{{ producto.subcategoria_id if producto else "" }}';
    
    // Limpiar subcategorías
    subcategoriaSelect.innerHTML = '<option value="">Seleccionar subcategoría...</option>';
    
    if (categoriaId) {
        fetch(`/api/subcategorias/${categoriaId}`)
            .then(response => response.json())
            .then(data => {
                data.forEach(subcategoria => {
                    const option = document.createElement('option');
                    option.value = subcategoria.id;
                    option.textContent = subcategoria.nombre;
                    
                    // Seleccionar la subcategoría actual si estamos editando
                    if (subcategoriaActual && subcategoria.id == subcategoriaActual) {
                        option.selected = true;
                    }
                    
                    subcategoriaSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error cargando subcategorías:', error);
            });
    }
}

// Cargar subcategorías al cargar la página si hay una categoría seleccionada
document.addEventListener('DOMContentLoaded', function() {
    const categoriaId = document.getElementById('categoria_id').value;
    if (categoriaId) {
        cargarSubcategorias();
    }
});
</script>
{% endblock %}